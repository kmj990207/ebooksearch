<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>전자책 통합 검색기 v2 (리팩터링)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
  /* 기본 스타일 유지 */
  body { font-family: "Noto Sans KR", sans-serif; background: #f4f4f4; padding: 30px; max-width: 800px; margin: auto; }
  h1 { text-align: center; color: #333; margin-bottom: 20px; }

  .search-container {
    position: relative;       /* 추가된 부분 */
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 20px;
  }
  .search-container select,
  .search-container input[type="text"],
  .search-container button {
    padding: 10px;
    font-size: 16px;
  }
  .search-container select { width: 140px; }
  .search-container input[type="text"] { flex: 1; box-sizing: border-box; }
  .search-container button {
    background: #0078D7;
    color: #fff;
    border: none;
    cursor: pointer;
    border-radius: 4px;
  }

  .platforms { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 10px; }
  .platforms label { flex: 1 1 45%; }

  .results {
    margin-top: 30px;
    background: white;
    padding: 20px;
    border-radius: 8px;
    position: relative;
  }
  .result-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid #eee;
    padding: 8px 0;
  }
  .result-row input[type="checkbox"] { margin-right: 10px; }

  #spinner {
    display: none;
    position: absolute;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    width: 40px; height: 40px;
  }
  #spinner .spinner {
    width: 100%; height: 100%;
    border: 4px solid rgba(0,0,0,0.1);
    border-top-color: #333;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  @media (max-width: 800px) {
    .platforms { flex-direction: column; }
    .search-container { flex-direction: column; align-items: stretch; }
    .search-container select,
    .search-container input,
    .search-container button { width: 100%; }
  }

  /* 커스텀 자동완성 스타일 */
  .autocomplete-items {
    position: absolute;
    border: 1px solid #d4d4d4;
    border-top: none;
    z-index: 99;
    top: calc(100% + 2px);
    left: 0; right: 0;
    background: #fff;
    max-height: 240px;
    overflow-y: auto;
  }
  .autocomplete-items div {
    padding: 10px;
    cursor: pointer;
  }
  .autocomplete-items div:hover {
    background-color: #e9e9e9;
  }
  .autocomplete-active {
    background-color: #0078D7 !important;
    color: #fff;
  }
  </style>
</head>
<body>
  <h1>전자책 통합 검색기 v2 (리팩터링)</h1>

  <div class="search-container">
    <select id="searchTypeSelect">
      <option value="both" selected>통합검색</option>
      <option value="title">책 제목</option>
      <option value="author">작가 이름</option>
    </select>
    <input
  type="text"
  id="bookTitle"
  placeholder="검색어를 입력하세요"
  autocomplete="off"
/> <!-- 브라우저 기본 자동완성 끄기 -->
<div id="autocomplete-list" class="autocomplete-items"></div>
    <button id="searchBtn">검색</button>
    <button id="btnReset">처음으로</button>
  </div>

  <div class="platforms" id="platformList"></div>
  <div style="margin-bottom:10px;">
    <button id="selectAllBtn" style="margin-right:10px;">플랫폼 전체선택</button>
    <button id="deselectAllBtn">플랫폼 전체해제</button>
  </div>

  <div class="results" id="results">
    <div id="spinner"><div class="spinner"></div></div>
  </div>

  <div id="resultControls" style="display:none; margin-top:10px;">
    <button id="selectAllResultsBtn" style="margin-right:10px;">결과 전체선택</button>
    <button id="deselectResultsBtn" style="margin-right:10px;">결과 전체해제</button>
    <button id="openSelectedBtn">선택한 항목 모두 이동</button>
  </div>

  <script>
    // 플랫폼 설정
 const platforms = {
  "리디셀렉트": {
    titleUrl:  "https://select.ridibooks.com/search?q={query}&type=Books",
    authorUrl: "https://select.ridibooks.com/search?q={query}&type=Books",
    bothUrl:   "https://select.ridibooks.com/search?q={query}&type=Books",  // 통합검색
    marker:    "class=\"book_card\""
  },
  "예스24 크레마클럽": {
    titleUrl:  "https://cremaclub.yes24.com/BookClub/Search?query={query}&page=1&_searchTarget=TITLE",
    authorUrl: "https://cremaclub.yes24.com/BookClub/Search?query={query}&page=1&_searchTarget=AUTHOR",
    bothUrl:   "https://cremaclub.yes24.com/BookClub/Search?query={query}",  // 통합검색
    marker:    "class=\"itemUnit\""
  },
  "알라딘 eBook": {
  // 통합검색: 대문자 B 사용
  bothUrl:
    "https://www.aladin.co.kr/search/wsearchresult.aspx?" +
    "SearchTarget=EBook&SearchWord={query}",

  // 제목 검색: 원본과 동일하게 소문자 b
  titleUrl:
    "https://www.aladin.co.kr/search/wsearchresult.aspx?" +
    "SearchTarget=Ebook&KeyWord=&KeyRecentPublish=0&OutStock=0&" +
    "ViewType=Detail&SortOrder=11&CustReviewCount=0&CustReviewRank=0&" +
    "KeyFullWord={query}&KeyLastWord={query}&CategorySearch=&" +
    "chkKeyTitle=on&chkKeyAuthor=&chkKeyPublisher=&chkKeyISBN=&" +
    "chkKeyTag=&chkKeyTOC=&chkKeySubject=&ViewRowCount=25&" +
    "SuggestKeyWord=&SearchFieldEnable=1",

  // 작가 검색: 원본과 동일
  authorUrl:
    "https://www.aladin.co.kr/search/wsearchresult.aspx?" +
    "SearchTarget=Ebook&KeyTitle=&KeyRecentPublish=0&OutStock=0&" +
    "ViewType=Detail&SortOrder=11&CustReviewCount=0&CustReviewRank=0&" +
    "KeyFullWord={query}&KeyLastWord={query}&SearchFieldEnable=1&" +
    "KeyWord=&CategorySearch=&chkKeyTitle=&chkKeyAuthor=on&" +
    "chkKeyPublisher=&chkKeyISBN=&chkKeyTag=&chkKeyTOC=&" +
    "chkKeySubject=&ViewRowCount=25&SuggestKeyWord=",

  marker: "<div class=\"ss_book_box\""
},


  "교보 eBook": {
    titleUrl:  "https://search.kyobobook.co.kr/search?keyword={query}&target=ebook&gbCode=EBK&cname={query}",
    authorUrl: "https://search.kyobobook.co.kr/search?keyword={query}&target=ebook&gbCode=EBK&chrc={query}",
    bothUrl:   "https://search.kyobobook.co.kr/search?keyword={query}&gbCode=EBK&target=ebook",  // 통합검색
    marker:    "<li class=\"prod_item\""
  },
  "서울도서관 전자도서관": {
    titleUrl:  "https://elib.seoul.go.kr/contents/search/content?t=EB&k={query}",
    authorUrl: "https://elib.seoul.go.kr/contents/search/content?t=EB&k={query}",
    bothUrl:   "https://elib.seoul.go.kr/contents/search/content?t=EB&k={query}",  // 통합검색
    marker:    "<ul class=\"book_resultList\""
  },
  "가톨릭대학교 전자도서관": {
    titleUrl:  "https://ebooks.catholic.ac.kr/elibrary-front/search/searchList.ink?schClst=ctts&schTxt={query}&recordCount=20",
    authorUrl: "https://ebooks.catholic.ac.kr/elibrary-front/search/searchList.ink?schClst=autr&schTxt={query}&recordCount=20",
    bothUrl:   "https://ebooks.catholic.ac.kr/elibrary-front/search/searchList.ink?schClst=all&schDvsn=000&schTxt={query}",  // 통합검색
    marker:    "<ul class=\"book_resultList\""
  }
};

    // DOM 참조
    const platformList       = document.getElementById('platformList');
    const resultsContainer   = document.getElementById('results');
    const resultControls     = document.getElementById('resultControls');
    const spinner            = document.getElementById('spinner');
    const searchBtn          = document.getElementById('searchBtn');
    const selectAllBtn       = document.getElementById('selectAllBtn');
    const deselectAllBtn     = document.getElementById('deselectAllBtn');
    const selectResultsBtn   = document.getElementById('selectAllResultsBtn');
    const deselectResultsBtn = document.getElementById('deselectResultsBtn');
    const openSelectedBtn    = document.getElementById('openSelectedBtn');
    let checkboxes = [];

    // 1) 플랫폼 체크박스 생성
    Object.keys(platforms).forEach(name => {
      const id = name.replace(/\s+/g, '');
      const label = document.createElement('label');
      label.innerHTML = `<input type="checkbox" id="${id}" checked> ${name}`;
      platformList.appendChild(label);
    });

    // 2) placeholder 변경 처리
    document.getElementById('searchTypeSelect').addEventListener('change', function() {
      const mode = this.value;
      const placeholderText = mode === 'title'
        ? '책 제목을 입력하세요'
        : mode === 'author'
          ? '작가 이름을 입력하세요'
          : '검색어를 입력하세요';
      document.getElementById('bookTitle').placeholder = placeholderText;
    });

    // 3) HTML fetch 함수
    async function fetchViaProxy(url) {
      const response = await fetch('https://api.allorigins.win/raw?url=' + encodeURIComponent(url));
      if (!response.ok) throw new Error(`네트워크 오류: ${response.status}`);
      return response.text();
    }

    // 4) 결과 카운트 파싱 함수
   function parseCount(siteName, html) {
    switch (siteName) {
      case '교보 eBook': {
        // 1) class 속성 뒤 추가 속성 허용
        // 2) <b> 태그 역시 속성 허용
        const m = html.match(
          /<p\s+class=["']result_count["'][^>]*>[\s\S]*?<b[^>]*>([\d,]+)<\/b>/
        );
        return m ? Number(m[1].replace(/,/g, '')) : 0;
      }
      case '예스24 크레마클럽': {
        const m = html.match(/상품\s*\(\s*([\d,]+)\s*\)/);
        return m ? Number(m[1].replace(/,/g, '')) : 0;
      }
      case '알라딘 eBook': {
        const m = html.match(/<span\s+class=["']ss_f_g_l["'][^>]*>([\d,]+)<\/span>/);
        return m ? Number(m[1].replace(/,/g, '')) : 0;
      }
      case '서울도서관 전자도서관': {
        let m = html.match(/<h2[^>]*id=["']ebookC["'][\s\S]*?<span>\(\s*(\d+)\s*건\)<\/span>/i);
        if (!m) {
          m = html.match(/"[^"]+"에 대한 검색결과\s*:\s*총\s*(\d+)\s*건/i);
        }
        return m ? Number(m[1].replace(/,/g, '')) : 0;
      }
      case '가톨릭대학교 전자도서관': {
        const m = html.match(/<strong>\s*총\s*([\d,]+)개<\/strong>/);
        return m ? Number(m[1].replace(/,/g, '')) : 0;
      }
      default: {
        const marker = platforms[siteName].marker || '';
        return html.split(marker).length - 1;
      }
    }
  }

    // ───────── 5) 검색 처리 (수정본) ─────────
async function searchBooks() {
  const query = document.getElementById('bookTitle').value.trim();
  const mode  = document.getElementById('searchTypeSelect').value;
  if (!query) {
    alert('검색어를 입력해주세요.');
    return;
  }

  // UI 초기화
  resultsContainer.querySelectorAll('.result-row').forEach(el => el.remove());
  checkboxes = [];
  resultControls.style.display = 'none';
  spinner.style.display = 'block';

  const encodedQuery = encodeURIComponent(query);
  const enabledSites = Object.keys(platforms).filter(name =>
    document.getElementById(name.replace(/\s+/g, '')).checked
  );

  // 1) 각 사이트별 fetch 실패 시에도 { site, error, url } 형태로 리턴하도록 catch 추가
  const results = await Promise.allSettled(
    enabledSites.map(site => {
      const tpl = mode === 'title'
                ? platforms[site].titleUrl
                : mode === 'author'
                  ? platforms[site].authorUrl
                  : platforms[site].bothUrl;
      const url = tpl.replaceAll('{query}', encodedQuery);
      return fetchViaProxy(url)
        .then(html => ({ site, html, url }))
        .catch(error => ({ site, error, url }));
    })
  );

  spinner.style.display = 'none';

  // 2) 결과 렌더링
  results.forEach(res => {
    // res.value 가 catch 에서 만든 객체이거나 then() 결과
    const { site, url, html, error } = res.value || res;

    let labelText, count = 0;
    if (error || res.status === 'rejected') {
      // 네트워크/프록시 오류
      labelText = `${site} (오류)`;
    } else {
      // 정상 HTML 파싱
      count = parseCount(site, html);
      labelText = `${site} (${count.toLocaleString()}건)`;
    }

    const row = document.createElement('div');
    row.className = 'result-row';

    const cb = document.createElement('input');
    cb.type = 'checkbox';
    cb.dataset.url = url;
    cb.checked = !error && count > 0;
    checkboxes.push(cb);

    const lbl = document.createElement('span');
    lbl.innerText = labelText;

    const btn = document.createElement('button');
    btn.innerText = '이동';
    btn.addEventListener('click', () => window.open(url, '_blank'));

    row.append(cb, lbl, btn);
    resultsContainer.appendChild(row);
  });

  if (checkboxes.length) {
    resultControls.style.display = 'block';
  }
}
// ────────────────────────────────────────────

// ───────── 자동완성(API) + 커스텀 드롭다운 로직 ─────────
const ALADIN_TTBKEY = 'ttbkuygjmhu2209001';

  async function fetchAladinSuggestions(query) {
    const endpoint =
      `https://www.aladin.co.kr/ttb/api/GraphicalSearch.aspx`
      + `?ttbkey=${ALADIN_TTBKEY}`
      + `&Query=${encodeURIComponent(query)}`
      + `&QueryType=Keyword`
      + `&MaxResults=10`
      + `&output=js`
      + `&Version=20131101`;
    const html = await fetchViaProxy(endpoint);
    const json = JSON.parse(
      html.replace(/^[^(]*\(/, '').replace(/\);?$/, '')
    );
    return json.item.map(i => i.title);
  }

  (function() {
    const input = document.getElementById('bookTitle');
    const list  = document.getElementById('autocomplete-list');
    let currentFocus = -1;

    // 1) 입력 시마다 제안어 목록 갱신
    input.addEventListener('input', async function() {
      const val = this.value.trim();
      list.innerHTML = '';
      currentFocus = -1;
      if (val.length < 2) return;

      const suggestions = await fetchAladinSuggestions(val);
      suggestions.forEach(word => {
        const item = document.createElement('div');
        item.innerHTML = `<strong>${word.substr(0, val.length)}</strong>${word.substr(val.length)}`;
        item.addEventListener('click', () => {
          input.value = word;
          list.innerHTML = '';
        });
        list.appendChild(item);
      });
    });

    // 2) 키보드 네비게이션 (↑↓, Enter)
    input.addEventListener('keydown', function(e) {
      const items = list.getElementsByTagName('div');
      if (!items.length) return;

      if (e.key === 'ArrowDown') {
        currentFocus++;
        addActive(items);
      } else if (e.key === 'ArrowUp') {
        currentFocus--;
        addActive(items);
      } else if (e.key === 'Enter') {
        e.preventDefault();
        if (currentFocus > -1) items[currentFocus].click();
      }
    });

    function addActive(items) {
      removeActive(items);
      if (currentFocus >= items.length) currentFocus = 0;
      if (currentFocus < 0) currentFocus = items.length - 1;
      items[currentFocus].classList.add('autocomplete-active');
      items[currentFocus].scrollIntoView({ block: 'nearest' });
    }
    function removeActive(items) {
      Array.from(items).forEach(i => i.classList.remove('autocomplete-active'));
    }

    // 3) 외부 클릭 시 목록 닫기
    document.addEventListener('click', function(e) {
      if (e.target !== input) list.innerHTML = '';
    });
  })();

  // 7) 버튼 이벤트 연결
  searchBtn.addEventListener('click', searchBooks);
  document.getElementById('bookTitle')
    .addEventListener('keydown', e => {
      if (e.key === 'Enter') {
        e.preventDefault();
        searchBooks();
      }
      const btnReset = document.getElementById('btnReset');
btnReset.addEventListener('click', () => {
  // 페이지를 완전히 다시 로드해서 초기 상태로 되돌립니다
  location.reload();
});  
    });
    selectAllBtn.addEventListener('click',    () => document.querySelectorAll('#platformList input').forEach(cb => cb.checked = true));
    deselectAllBtn.addEventListener('click',  () => document.querySelectorAll('#platformList input').forEach(cb => cb.checked = false));
    selectResultsBtn.addEventListener('click',() => checkboxes.forEach(cb => cb.checked = true));
    deselectResultsBtn.addEventListener('click', () => checkboxes.forEach(cb => cb.checked = false));
    openSelectedBtn.addEventListener('click', () => checkboxes.forEach(cb => cb.checked && window.open(cb.dataset.url, '_blank')));
  </script>
</body>
</html>
